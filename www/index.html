<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Dashboard - SPA</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Vue.js from CDN - Latest version -->
    <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.js"></script>
    <!-- Vue Router from CDN - Latest version -->
    <script src="https://unpkg.com/vue-router@4.3.0/dist/vue-router.global.js"></script>
    <style>
        /* Base styles for SPA */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #333;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin: 0;
            padding: 20px 0;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h2,
        h3 {
            color: #34495e;
            margin-top: 20px;
        }

        /* Navigation tabs - always visible at top */
        .nav-tabs {
            display: flex;
            background-color: #34495e;
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .nav-tabs button {
            flex: 1;
            padding: 15px 20px;
            font-size: 16px;
            background: none;
            border: none;
            color: #ecf0f1;
            cursor: pointer;
            transition: all 0.3s;
            outline: none;
        }

        .nav-tabs button:hover {
            background-color: #2c3e50;
        }

        .nav-tabs button.active {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }

        /* App container with spacing for fixed navigation */
        .app-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px 40px;
        }

        /* Tab content */
        .tab-content {
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* Form styling */
        .form-container {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px 5px 5px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        /* List containers */
        .list-container {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .item-list {
            list-style-type: none;
            padding: 0;
        }

        .item-list li {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-list li:last-child {
            border-bottom: none;
        }

        .item-list li .actions {
            display: flex;
        }

        /* Edit form styling */
        .edit-form {
            border-left: 4px solid #3498db;
        }

        /* Messages */
        .message {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        /* Delete button */
        button.delete-btn {
            background-color: #e74c3c;
        }

        button.delete-btn:hover {
            background-color: #c0392b;
        }

        /* Loading indicator */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>

<body>
    <div id="app">
        <h1>Management Dashboard</h1>

        <!-- Navigation using Vue Router -->
        <div class="nav-tabs">
            <router-link v-for="route in routes" :key="route.path" :to="route.path" custom
                v-slot="{ navigate, isActive }">
                <button @click="navigate" :class="{ active: isActive }">
                    {{ route.name }}
                </button>
            </router-link>
        </div>

        <div class="app-container">
            <router-view></router-view>
        </div>
    </div>

    <script>
        // API Base URL
        const API_URL = 'api.php';

        // Initialize Vue Application with Vue 3
        const { createApp, ref, reactive, watch, onMounted, provide, inject } = Vue;
        const { createRouter, createWebHashHistory } = VueRouter;

        // Component Templates
        const TeachersComponent = {
            setup() {
                // Access the global state using inject
                const {
                    teachers,
                    loading,
                    messages,
                    newTeacher,
                    editMode,
                    editingTeacher,
                    addTeacher,
                    editTeacher,
                    updateTeacher,
                    deleteTeacher,
                    cancelEdit
                } = inject('globalState');

                return {
                    teachers,
                    loading,
                    messages,
                    newTeacher,
                    editMode,
                    editingTeacher,
                    addTeacher,
                    editTeacher,
                    updateTeacher,
                    deleteTeacher,
                    cancelEdit
                };
            },
            template: `
                <div class="tab-content">
                    <h2>Manage Teachers</h2>
                    
                    <!-- Message display -->
                    <div v-if="messages.teachers" class="message" :class="messages.teachers.type">
                        {{ messages.teachers.text }}
                    </div>
                    
                    <!-- Add Teacher Form -->
                    <div class="form-container">
                        <h3>Add New Teacher</h3>
                        <div class="form-group">
                            <label for="teacherName">Name:</label>
                            <input id="teacherName" v-model="newTeacher.name" placeholder="Teacher Name" />
                        </div>
                        <div class="form-group">
                            <label for="teacherEmail">Email:</label>
                            <input id="teacherEmail" type="email" v-model="newTeacher.email" placeholder="Email Address" />
                        </div>
                        <button @click="addTeacher">Add Teacher</button>
                    </div>
                    
                    <!-- Edit Teacher Form (conditionally shown) -->
                    <div class="form-container edit-form" v-if="editMode.teachers">
                        <h3>Edit Teacher</h3>
                        <div class="form-group">
                            <label for="editTeacherName">Name:</label>
                            <input id="editTeacherName" v-model="editingTeacher.name" />
                        </div>
                        <div class="form-group">
                            <label for="editTeacherEmail">Email:</label>
                            <input id="editTeacherEmail" type="email" v-model="editingTeacher.email" />
                        </div>
                        <button @click="updateTeacher">Save Changes</button>
                        <button @click="cancelEdit('teachers')">Cancel</button>
                    </div>
                    
                    <!-- Teachers List -->
                    <div class="list-container">
                        <h3>Existing Teachers</h3>
                        <div v-if="loading.teachers" class="loading">Loading teachers...</div>
                        <table v-else>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="teacher in teachers" :key="teacher.id">
                                    <td>{{ teacher.name }}</td>
                                    <td>{{ teacher.email }}</td>
                                    <td>
                                        <button @click="editTeacher(teacher)">Edit</button>
                                        <button class="delete-btn" @click="deleteTeacher(teacher.id)">Delete</button>
                                    </td>
                                </tr>
                                <tr v-if="teachers.length === 0">
                                    <td colspan="3">No teachers found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `,
        };

        const CoursesComponent = {
            setup() {
                // Access the global state using inject
                const {
                    courses,
                    topics,
                    teachers,
                    loading,
                    messages,
                    newCourse,
                    newTopic,
                    editMode,
                    editingCourse,
                    addCourse,
                    editCourse,
                    updateCourse,
                    deleteCourse,
                    addTopic,
                    deleteTopic,
                    assignTeacher,
                    cancelEdit
                } = inject('globalState');

                return {
                    courses,
                    topics,
                    teachers,
                    loading,
                    messages,
                    newCourse,
                    newTopic,
                    editMode,
                    editingCourse,
                    addCourse,
                    editCourse,
                    updateCourse,
                    deleteCourse,
                    addTopic,
                    deleteTopic,
                    assignTeacher,
                    cancelEdit
                };
            },
            template: `
                <div class="tab-content">
                    <h2>Manage Courses & Topics</h2>
                    
                    <!-- Message display -->
                    <div v-if="messages.courses" class="message" :class="messages.courses.type">
                        {{ messages.courses.text }}
                    </div>
                    
                    <!-- Add Course Form -->
                    <div class="form-container">
                        <h3>Add New Course</h3>
                        <div class="form-group">
                            <label for="courseName">Course Name:</label>
                            <input id="courseName" v-model="newCourse.name" placeholder="Course Name" />
                        </div>
                        <button @click="addCourse">Add Course</button>
                    </div>
                    
                    <!-- Edit Course Form (conditionally shown) -->
                    <div class="form-container edit-form" v-if="editMode.courses">
                        <h3>Edit Course</h3>
                        <div class="form-group">
                            <label for="editCourseName">Name:</label>
                            <input id="editCourseName" v-model="editingCourse.name" />
                        </div>
                        <button @click="updateCourse">Save Changes</button>
                        <button @click="cancelEdit('courses')">Cancel</button>
                    </div>
                    
                    <!-- Courses List -->
                    <div class="list-container">
                        <h3>Existing Courses</h3>
                        <div v-if="loading.courses" class="loading">Loading courses...</div>
                        <table v-else>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="course in courses" :key="course.id">
                                    <td>{{ course.name }}</td>
                                    <td>
                                        <button @click="editCourse(course)">Edit</button>
                                        <button class="delete-btn" @click="deleteCourse(course.id)">Delete</button>
                                    </td>
                                </tr>
                                <tr v-if="courses.length === 0">
                                    <td colspan="2">No courses found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Add Topic Form -->
                    <div class="form-container">
                        <h3>Add New Topic</h3>
                        <div class="form-group">
                            <label for="topicTitle">Topic Title:</label>
                            <input id="topicTitle" v-model="newTopic.title" placeholder="Topic Title" />
                        </div>
                        <div class="form-group">
                            <label for="topicCourse">Course:</label>
                            <select id="topicCourse" v-model="newTopic.course_id" aria-label="Select course for topic">
                                <option v-for="course in courses" :key="course.id" :value="course.id">
                                    {{ course.name }}
                                </option>
                            </select>
                        </div>
                        <button @click="addTopic" :disabled="courses.length === 0">Add Topic</button>
                    </div>
                    
                    <!-- Topics List -->
                    <div class="list-container">
                        <h3>Existing Topics</h3>
                        <div v-if="loading.topics" class="loading">Loading topics...</div>
                        <table v-else>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Course</th>
                                    <th>Assigned Teacher</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="topic in topics" :key="topic.id">
                                    <td>{{ topic.title }}</td>
                                    <td>{{ topic.course_name }}</td>
                                    <td>
                                        <select v-model="topic.teacher_id" aria-label="Assign teacher to topic"
                                                @change="assignTeacher(topic.id, topic.teacher_id)">
                                            <option value="">-- Unassigned --</option>
                                            <option v-for="teacher in teachers" :key="teacher.id" :value="teacher.id">
                                                {{ teacher.name }}
                                            </option>
                                        </select>
                                    </td>
                                    <td>
                                        <button class="delete-btn" @click="deleteTopic(topic.id)">Delete</button>
                                    </td>
                                </tr>
                                <tr v-if="topics.length === 0">
                                    <td colspan="4">No topics found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `,
        };

        const StudentsComponent = {
            setup() {
                // Access the global state using inject
                const {
                    students,
                    topics,
                    topicStudents,
                    loading,
                    messages,
                    newStudent,
                    newSubscription,
                    editMode,
                    editingStudent,
                    selectedTopicId,
                    selectedTopicName,
                    addStudent,
                    editStudent,
                    updateStudent,
                    deleteStudent,
                    subscribeStudentToTopic,
                    viewStudentsOfTopic,
                    cancelEdit
                } = inject('globalState');

                return {
                    students,
                    topics,
                    topicStudents,
                    loading,
                    messages,
                    newStudent,
                    newSubscription,
                    editMode,
                    editingStudent,
                    selectedTopicId,
                    selectedTopicName,
                    addStudent,
                    editStudent,
                    updateStudent,
                    deleteStudent,
                    subscribeStudentToTopic,
                    viewStudentsOfTopic,
                    cancelEdit
                };
            },
            template: `
                <div class="tab-content">
                    <h2>Manage Students</h2>
                    
                    <!-- Message display -->
                    <div v-if="messages.students" class="message" :class="messages.students.type">
                        {{ messages.students.text }}
                    </div>
                    
                    <!-- Add Student Form -->
                    <div class="form-container">
                        <h3>Add New Student</h3>
                        <div class="form-group">
                            <label for="studentName">Name:</label>
                            <input id="studentName" v-model="newStudent.name" placeholder="Student Name" />
                        </div>
                        <div class="form-group">
                            <label for="studentEmail">Email:</label>
                            <input id="studentEmail" type="email" v-model="newStudent.email" placeholder="Email Address" />
                        </div>
                        <button @click="addStudent">Add Student</button>
                    </div>
                    
                    <!-- Edit Student Form (conditionally shown) -->
                    <div class="form-container edit-form" v-if="editMode.students">
                        <h3>Edit Student</h3>
                        <div class="form-group">
                            <label for="editStudentName">Name:</label>
                            <input id="editStudentName" v-model="editingStudent.name" />
                        </div>
                        <div class="form-group">
                            <label for="editStudentEmail">Email:</label>
                            <input id="editStudentEmail" type="email" v-model="editingStudent.email" />
                        </div>
                        <button @click="updateStudent">Save Changes</button>
                        <button @click="cancelEdit('students')">Cancel</button>
                    </div>
                    
                    <!-- Subscribe to Topic Form -->
                    <div class="form-container" v-if="topics.length > 0 && students.length > 0">
                        <h3>Subscribe Student to Topic</h3>
                        <div class="form-group">
                            <label for="selectStudent">Student:</label>
                            <select id="selectStudent" v-model="newSubscription.student_id" aria-label="Select student to subscribe">
                                <option v-for="student in students" :key="student.id" :value="student.id">
                                    {{ student.name }}
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="selectTopic">Topic:</label>
                            <select id="selectTopic" v-model="newSubscription.topic_id" aria-label="Select topic for subscription">
                                <option v-for="topic in topics" :key="topic.id" :value="topic.id">
                                    {{ topic.title }} ({{ topic.course_name }})
                                </option>
                            </select>
                        </div>
                        <button @click="subscribeStudentToTopic">Subscribe</button>
                    </div>
                    
                    <!-- Students List -->
                    <div class="list-container">
                        <h3>All Students</h3>
                        <div v-if="loading.students" class="loading">Loading students...</div>
                        <table v-else>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="student in students" :key="student.id">
                                    <td>{{ student.name }}</td>
                                    <td>{{ student.email }}</td>
                                    <td>
                                        <button @click="editStudent(student)">Edit</button>
                                        <button class="delete-btn" @click="deleteStudent(student.id)">Delete</button>
                                    </td>
                                </tr>
                                <tr v-if="students.length === 0">
                                    <td colspan="3">No students found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- View Topic Students -->
                    <div class="form-container" v-if="topics.length > 0">
                        <h3>View Students by Topic</h3>
                        <div class="form-group">
                            <label for="viewTopic">Select Topic:</label>
                            <select id="viewTopic" v-model="selectedTopicId" aria-label="Select topic to view students" 
                                    @change="viewStudentsOfTopic">
                                <option v-for="topic in topics" :key="topic.id" :value="topic.id">
                                    {{ topic.title }} ({{ topic.course_name }})
                                </option>
                            </select>
                        </div>
                        <div v-if="selectedTopicId && topicStudents.length > 0" class="list-container">
                            <h4>Students in Topic: {{ selectedTopicName }}</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="student in topicStudents" :key="student.id">
                                        <td>{{ student.name }}</td>
                                        <td>{{ student.email }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div v-else-if="selectedTopicId" class="message">
                            No students enrolled in this topic.
                        </div>
                    </div>
                </div>
            `,
        };

        // Define routes
        const routes = [
            { path: '/', redirect: '/teachers' },
            { path: '/teachers', name: 'Teachers', component: TeachersComponent },
            { path: '/courses', name: 'Courses & Topics', component: CoursesComponent },
            { path: '/students', name: 'Students', component: StudentsComponent }
        ];

        // Create the router instance
        const router = createRouter({
            history: createWebHashHistory(),
            routes
        });

        // Create Vue app
        createApp({
            setup() {
                // Navigation
                const activeTab = ref('teachers');
                const tabs = [
                    { id: 'teachers', name: 'Teachers' },
                    { id: 'courses', name: 'Courses & Topics' },
                    { id: 'students', name: 'Students' }
                ];

                // Data collections
                const teachers = ref([]);
                const courses = ref([]);
                const topics = ref([]);
                const students = ref([]);
                const topicStudents = ref([]);

                // New item models
                const newTeacher = reactive({ name: '', email: '' });
                const newCourse = reactive({ name: '' });
                const newTopic = reactive({ title: '', course_id: '' });
                const newStudent = reactive({ name: '', email: '' });
                const newSubscription = reactive({ student_id: '', topic_id: '' });

                // Edit mode flags and models
                const editMode = reactive({ teachers: false, courses: false, students: false });
                const editingTeacher = reactive({ id: null, name: '', email: '' });
                const editingCourse = reactive({ id: null, name: '' });
                const editingStudent = reactive({ id: null, name: '', email: '' });

                // Topic selection for viewing students
                const selectedTopicId = ref('');
                const selectedTopicName = ref('');

                // UI state
                const loading = reactive({
                    teachers: false,
                    courses: false,
                    topics: false,
                    students: false
                });

                // Message handling
                const messages = reactive({
                    teachers: null,
                    courses: null,
                    students: null
                });

                // API Communication Methods
                const apiRequest = async (method, endpoint, data = null) => {
                    try {
                        let url = `${API_URL}?action=${endpoint}`;
                        const options = {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        };

                        // For GET requests, append data as query parameters
                        if (method === 'GET' && data) {
                            const params = new URLSearchParams();
                            for (const key in data) {
                                params.append(key, data[key]);
                            }
                            const queryString = params.toString();
                            if (queryString) {
                                url += `&${queryString}`;
                            }
                        }
                        // For non-GET requests, include data in request body
                        else if (data) {
                            options.body = JSON.stringify(data);
                        }

                        const response = await fetch(url, options);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return await response.json();
                    } catch (error) {
                        console.error(`API Error (${endpoint}):`, error);
                        throw error;
                    }
                };

                // Teacher Methods
                const fetchTeachers = async () => {
                    loading.teachers = true;
                    try {
                        const response = await apiRequest('GET', 'getTeachers');
                        teachers.value = response.data;
                    } catch (error) {
                        showMessage('teachers', 'Error loading teachers', 'error');
                    } finally {
                        loading.teachers = false;
                    }
                };

                const addTeacher = async () => {
                    try {
                        await apiRequest('POST', 'addTeacher', newTeacher);
                        showMessage('teachers', 'Teacher added successfully', 'success');
                        newTeacher.name = '';
                        newTeacher.email = '';
                        fetchTeachers();
                    } catch (error) {
                        showMessage('teachers', 'Error adding teacher', 'error');
                    }
                };

                const editTeacher = (teacher) => {
                    editingTeacher.id = teacher.id;
                    editingTeacher.name = teacher.name;
                    editingTeacher.email = teacher.email;
                    editMode.teachers = true;
                };

                const updateTeacher = async () => {
                    try {
                        await apiRequest('PUT', 'updateTeacher', editingTeacher);
                        showMessage('teachers', 'Teacher updated successfully', 'success');
                        cancelEdit('teachers');
                        fetchTeachers();
                    } catch (error) {
                        showMessage('teachers', 'Error updating teacher', 'error');
                    }
                };

                const deleteTeacher = async (id) => {
                    if (confirm('Are you sure you want to delete this teacher?')) {
                        try {
                            await apiRequest('DELETE', 'deleteTeacher', { id });
                            showMessage('teachers', 'Teacher deleted successfully', 'success');
                            fetchTeachers();
                            fetchTopics(); // Refresh topics to update teacher assignments
                        } catch (error) {
                            showMessage('teachers', 'Error deleting teacher', 'error');
                        }
                    }
                };

                // Course Methods
                const fetchCourses = async () => {
                    loading.courses = true;
                    try {
                        const response = await apiRequest('GET', 'getCourses');
                        courses.value = response.data;
                        // Set default course_id for new topics if courses exist
                        if (courses.value.length > 0 && !newTopic.course_id) {
                            newTopic.course_id = courses.value[0].id;
                        }
                    } catch (error) {
                        showMessage('courses', 'Error loading courses', 'error');
                    } finally {
                        loading.courses = false;
                    }
                };

                const addCourse = async () => {
                    try {
                        await apiRequest('POST', 'addCourse', newCourse);
                        showMessage('courses', 'Course added successfully', 'success');
                        newCourse.name = '';
                        fetchCourses();
                    } catch (error) {
                        showMessage('courses', 'Error adding course', 'error');
                    }
                };

                const editCourse = (course) => {
                    editingCourse.id = course.id;
                    editingCourse.name = course.name;
                    editMode.courses = true;
                };

                const updateCourse = async () => {
                    try {
                        await apiRequest('PUT', 'updateCourse', editingCourse);
                        showMessage('courses', 'Course updated successfully', 'success');
                        cancelEdit('courses');
                        fetchCourses();
                        fetchTopics(); // Refresh topics to update course names
                    } catch (error) {
                        showMessage('courses', 'Error updating course', 'error');
                    }
                };

                const deleteCourse = async (id) => {
                    if (confirm('Are you sure you want to delete this course? All associated topics will also be deleted.')) {
                        try {
                            await apiRequest('DELETE', 'deleteCourse', { id });
                            showMessage('courses', 'Course deleted successfully', 'success');
                            fetchCourses();
                            fetchTopics(); // Refresh topics list after deletion
                        } catch (error) {
                            showMessage('courses', 'Error deleting course', 'error');
                        }
                    }
                };

                // Topic Methods
                const fetchTopics = async () => {
                    loading.topics = true;
                    try {
                        const response = await apiRequest('GET', 'getTopics');
                        topics.value = response.data;
                        // Set default topic_id for subscriptions if topics exist
                        if (topics.value.length > 0 && !newSubscription.topic_id) {
                            newSubscription.topic_id = topics.value[0].id;
                        }
                        // Set default topic for viewing students if topics exist
                        if (topics.value.length > 0 && !selectedTopicId.value) {
                            selectedTopicId.value = topics.value[0].id;
                        }
                    } catch (error) {
                        showMessage('courses', 'Error loading topics', 'error');
                    } finally {
                        loading.topics = false;
                    }
                };

                const addTopic = async () => {
                    try {
                        await apiRequest('POST', 'addTopic', newTopic);
                        showMessage('courses', 'Topic added successfully', 'success');
                        newTopic.title = '';
                        newTopic.course_id = courses.value.length > 0 ? courses.value[0].id : '';
                        fetchTopics();
                    } catch (error) {
                        showMessage('courses', 'Error adding topic', 'error');
                    }
                };

                const deleteTopic = async (id) => {
                    if (confirm('Are you sure you want to delete this topic?')) {
                        try {
                            await apiRequest('DELETE', 'deleteTopic', { id });
                            showMessage('courses', 'Topic deleted successfully', 'success');
                            fetchTopics();
                        } catch (error) {
                            showMessage('courses', 'Error deleting topic', 'error');
                        }
                    }
                };

                const assignTeacher = async (topicId, teacherId) => {
                    try {
                        await apiRequest('PUT', 'assignTeacher', { topic_id: topicId, teacher_id: teacherId });
                        showMessage('courses', 'Teacher assigned successfully', 'success');
                        fetchTopics();
                    } catch (error) {
                        showMessage('courses', 'Error assigning teacher', 'error');
                    }
                };

                // Student Methods
                const fetchStudents = async () => {
                    loading.students = true;
                    try {
                        const response = await apiRequest('GET', 'getStudents');
                        students.value = response.data;
                        // Set default student_id for subscriptions if students exist
                        if (students.value.length > 0 && !newSubscription.student_id) {
                            newSubscription.student_id = students.value[0].id;
                        }
                    } catch (error) {
                        showMessage('students', 'Error loading students', 'error');
                    } finally {
                        loading.students = false;
                    }
                };

                const addStudent = async () => {
                    try {
                        await apiRequest('POST', 'addStudent', newStudent);
                        showMessage('students', 'Student added successfully', 'success');
                        newStudent.name = '';
                        newStudent.email = '';
                        fetchStudents();
                    } catch (error) {
                        showMessage('students', 'Error adding student', 'error');
                    }
                };

                const editStudent = (student) => {
                    editingStudent.id = student.id;
                    editingStudent.name = student.name;
                    editingStudent.email = student.email;
                    editMode.students = true;
                };

                const updateStudent = async () => {
                    try {
                        await apiRequest('PUT', 'updateStudent', editingStudent);
                        showMessage('students', 'Student updated successfully', 'success');
                        cancelEdit('students');
                        fetchStudents();

                        // If we're viewing topic students, refresh that view too
                        if (selectedTopicId.value && topicStudents.value.length > 0) {
                            viewStudentsOfTopic();
                        }
                    } catch (error) {
                        showMessage('students', 'Error updating student', 'error');
                    }
                };

                const deleteStudent = async (id) => {
                    if (confirm('Are you sure you want to delete this student?')) {
                        try {
                            await apiRequest('DELETE', 'deleteStudent', { id });
                            showMessage('students', 'Student deleted successfully', 'success');
                            fetchStudents();

                            // If we're viewing topic students, refresh that view too
                            if (selectedTopicId.value && topicStudents.value.length > 0) {
                                viewStudentsOfTopic();
                            }
                        } catch (error) {
                            showMessage('students', 'Error deleting student', 'error');
                        }
                    }
                };

                const subscribeStudentToTopic = async () => {
                    try {
                        await apiRequest('POST', 'subscribeStudentToTopic', newSubscription);
                        showMessage('students', 'Student subscribed to topic successfully', 'success');

                        // If we're viewing the same topic, refresh the view
                        if (selectedTopicId.value === newSubscription.topic_id) {
                            viewStudentsOfTopic();
                        }
                    } catch (error) {
                        showMessage('students', 'Error subscribing student to topic', 'error');
                    }
                };

                const viewStudentsOfTopic = async () => {
                    if (!selectedTopicId.value) return;

                    try {
                        const response = await apiRequest('GET', 'getTopicStudents', { topic_id: selectedTopicId.value });
                        topicStudents.value = response.data;

                        // Find the topic name
                        const topic = topics.value.find(t => t.id === selectedTopicId.value);
                        selectedTopicName.value = topic ? topic.title : '';
                    } catch (error) {
                        showMessage('students', 'Error loading topic students', 'error');
                        topicStudents.value = [];
                    }
                };

                // UI Helper Methods
                const cancelEdit = (section) => {
                    editMode[section] = false;

                    // Reset editing models
                    if (section === 'teachers') {
                        editingTeacher.id = null;
                        editingTeacher.name = '';
                        editingTeacher.email = '';
                    } else if (section === 'courses') {
                        editingCourse.id = null;
                        editingCourse.name = '';
                    } else if (section === 'students') {
                        editingStudent.id = null;
                        editingStudent.name = '';
                        editingStudent.email = '';
                    }
                };

                const showMessage = (section, text, type) => {
                    messages[section] = { text, type };

                    // Auto-dismiss after 3 seconds
                    setTimeout(() => {
                        if (messages[section] && messages[section].text === text) {
                            messages[section] = null;
                        }
                    }, 3000);
                };

                // Watch for URL hash changes
                watch(activeTab, (newTab) => {
                    window.location.hash = newTab;
                });

                // Lifecycle hooks
                onMounted(() => {
                    // Load all data when component mounts
                    fetchTeachers();
                    fetchCourses();
                    fetchTopics();
                    fetchStudents();

                    // Check for URL hash to set active tab
                    const hash = window.location.hash.substring(1);
                    if (hash && tabs.some(tab => tab.id === hash)) {
                        activeTab.value = hash;
                    }
                });

                // Provide global state
                provide('globalState', {
                    teachers,
                    courses,
                    topics,
                    students,
                    topicStudents,
                    newTeacher,
                    newCourse,
                    newTopic,
                    newStudent,
                    newSubscription,
                    editMode,
                    editingTeacher,
                    editingCourse,
                    editingStudent,
                    selectedTopicId,
                    selectedTopicName,
                    loading,
                    messages,
                    fetchTeachers,
                    addTeacher,
                    editTeacher,
                    updateTeacher,
                    deleteTeacher,
                    fetchCourses,
                    addCourse,
                    editCourse,
                    updateCourse,
                    deleteCourse,
                    fetchTopics,
                    addTopic,
                    deleteTopic,
                    assignTeacher,
                    fetchStudents,
                    addStudent,
                    editStudent,
                    updateStudent,
                    deleteStudent,
                    subscribeStudentToTopic,
                    viewStudentsOfTopic,
                    cancelEdit,
                    showMessage
                });

                // Return everything that should be accessible in the template
                return {
                    activeTab,
                    tabs,
                    routes // Make routes available to the template
                };
            }
        }).use(router).mount('#app');
    </script>
</body>

</html>